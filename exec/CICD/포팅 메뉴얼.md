# Ìè¨Îî© Îß§Îâ¥Ïñº

### 1. NginX ÏÑ§Ïπò

```bash
sudo apt-get update
sudo apt install nginx
```

- NginXÎ¶¨Î≤ÑÏä§ÌîÑÎ°ùÏãú ÏÑ§Ï†ï

```bash
# sites-available, sites-enabledÎäî ÎçîÏù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÎäî ÏÑ§Ï†ïÎ∞©Î≤ï, Îî∞ÎùºÏÑú conf.dÌè¥ÎçîÎ•º ÏàòÏ†ïÌï®
cd etc/nginx/conf.d
sudo vim default.conf
```

- default.conf ÌååÏùº ÏÉùÏÑ± ÌõÑ ÎÇ¥Ïö© Ï±ÑÏö∞Í∏∞

```bash
server {
    listen 80;
    server_name [ÎÇ¥ ÎèÑÎ©îÏù∏];

    location / {
        proxy_pass http://192.168.XXX.XXX;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
    }
}
```

- certbot(SSL) ÏÑ§Ïπò

```bash
sudo add-apt-repository ppa:certbot/certbot 

sudo apt-get update # Ìï¥Îãπ Ï†ÄÏû•ÏÜåÏóê Îã¥Í∏¥ Ìå®ÌÇ§ÏßÄ Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï† Ïàò ÏûàÎèÑÎ°ù ÏóÖÎç∞Ïù¥Ìä∏

sudo apt-get install python3-certbot-nginx # certbot ÏÑ§Ïπò

# ÏÑ§ÏπòÎêú certvotÏùÑ Ïù¥Ïö©ÌïòÏó¨ ÎèÑÎ©îÏù∏(example.com)Ïóê ÎåÄÌïú SSL Ïù∏Ï¶ùÏÑú Î∞úÍ∏â 
sudo certbot certonly --nginx -d j8b105.p.ssafy.io(ÎèÑÎ©îÏù∏)

# Îã§Ïùå Í≤ΩÎ°úÏóê 5Í∞úÏùò ÌååÏùº(4Í∞úÏùò .pem, 1Í∞úÏùò readme) ÏÉùÏÑ± ÌôïÏù∏ 
sudo ls -al /etc/letsencrypt/live/j8b105.p.ssafy.io(ÎèÑÎ©îÏù∏)

# 90ÏùºÎßàÎã§ ÎßåÎ£åÎêòÎäî Ïù∏Ï¶ùÏÑú ÏûêÎèô Í∞±Ïã† 
sudo certbot renew --dry-run
```

- NginX ÏÑ§Ï†ï ÌååÏùº ÏàòÏ†ï

```bash
# cd etc/nginx/conf.d
# sudo vim default.conf

# etc/nginx/conf.d/default.conf

# redirect ÏΩîÎìú(80Ìè¨Ìä∏ Ï†ëÍ∑º Ïãú 443ÏúºÎ°ú)
server {
  listen 80; #80Ìè¨Ìä∏Î°ú Î∞õÏùÑ Îïå
  server_name j8b105.p.ssafy.io  www.j8b105.p.ssafy.io; #ÎèÑÎ©îÏù∏Ï£ºÏÜå, ÏóÜÏùÑÍ≤ΩÏö∞ localhost
  return 301 https://j8b105.p.ssafy.io$request_uri;

}
server {
  listen 443 ssl;
  server_name j8b105.p.ssafy.io www.j8b105.p.ssafy.io;

  # ssl Ïù∏Ï¶ùÏÑú Ï†ÅÏö©ÌïòÍ∏∞
  ssl_certificate /etc/letsencrypt/live/j8b105.p.ssafy.io/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/j8b105.p.ssafy.io/privkey.pem;

        location / { # ÌîÑÎ°†Ìä∏ÏóîÎìú
                proxy_pass http://localhost:3000;
        }

  location /src/ { # ÌîåÎùºÏä§ÌÅ¨ ÏÑúÎ≤Ñ
    proxy_pass http://localhost:90/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme; # https ÌïÑÏöî
}

  location /api { # Ïä§ÌîÑÎßÅ Î∂ÄÌä∏ ÏÑúÎ≤Ñ
    proxy_pass http://localhost:8080;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme; # https ÌïÑÏöî
  }

}
```

- NginX Ïû¨ÏãúÏûë

```bash
sudo service nginx restart
```

### 2. MySQL ÏÑ§Ïπò

- MySQL APT Repository Ï∂îÍ∞Ä & Ìå®ÌÇ§ÏßÄ Îã§Ïö¥Î°úÎìú

```bash
sudo wget https://dev.mysql.com/get/mysql-apt-config_0.8.13-1_all.deb
sudo dpkg -i mysql-apt-config_0.8,13-1_all.deb
```

- MySQL ÏÑ§Ïπò

```bash
sudo apt-get update
sudo apt-get install mysql-server
```

- Î∞©ÌôîÎ≤Ω ÌóàÏö©(Workbench Ïì∞Í∏∞ ÏúÑÌï¥ÏÑú)

```bash
sudo ufw allow mysql
```

- MySQL Ï†ëÏÜç

```bash
sudo /usr/bin/mysql -u root -p
```

### 3. Docker ÏÑ§Ïπò

- Ìå®ÌÇ§ÏßÄ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏

```bash
sudo apt-get update
```

- Í∏∞Î≥∏Ï†ÅÏù∏ ÏÑ§Ïπò

```bash
sudo apt-get install \
apt-transport-https \
ca-certificates \
curl \
gnupg-agent \
software-proerties-common
```

- curlÏùÑ Ïù¥Ïö©Ìï¥ docker Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞

```bash
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add
```

- apt-key Îì±Î°ùÎê¨ÎäîÏßÄ ÌôïÏù∏

```bash
apt-key fingerprint 0EBFCD88
```

- PPA Ï†ÄÏû•ÏÜå Ï∂îÍ∞Ä

```bash
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"
```

- Ï†ÄÏû•ÏÜå Ìå®ÌÇ§ÏßÄ Í∞±Ïã†

```bash
sudo apt update
```

- ÎèÑÏª§ ÏÑ§Ïπò

```bash
sudo apt-cache policy docker-ce
sudo apt install docker-ce
```

### 4. Jenkins ÏÑ§Ïπò(Docker outside of Docker)

- Ï††ÌÇ®Ïä§ Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä

```bash
docker pull jenkinsci/blueocrean
```

- Ï††ÌÇ®Ïä§ Ïã§Ìñâ

```bash
sudo docker run -d \
-u root \
-p 9090:8080 \
--name=jenkins \
-v /home/ubuntu/docker/jenkins-data:/var/jenkins_home \
-v /var/run/docker.sock:/var/run/docker.sock \
-v "$HOME":/home/jenkinsci/blueocean \
jenkinsci/blueocean
```

- Ï††ÌÇ®Ïä§ Ïª®ÌÖåÏù¥ÎÑà Ï†ëÏÜç

```bash
sudo docker exec -it jenkins bash
```

- Ï††ÌÇ®Ïä§ Ï†ëÏÜç ÎπÑÎ∞ÄÎ≤àÌò∏ Í∞ÄÏ†∏Ïò§Í∏∞

```bash
cat /var/jenkins_home/secrets/initialAdminPassword
```

### 5. Jenkins Pipeline Íµ¨Ï∂ï

- CredentialÏùÑ ÏúÑÌï¥ Gitlab API Token Î∞úÍ∏â
- Jenkins Dashboard ‚Üí ÏÉàÎ°úÏö¥ Item ‚Üí pipeline ÎßåÎì§Í∏∞

### 6. Jenkins Pipeline Script(scm)

- Back ÏÑúÎ≤Ñ

```bash
pipeline{
    agent any
    environment {
       BACK_SPRING_CONTAINER_NAME="candy_back_spring_container"
       BACK_SPRING_NAME = "candy_back_spring"

       BACK_FLASK_CONTAINER_NAME="candy_back_flask_container"
       BACK_FLASK_NAME = "candy_back_flask"
    }
    stages {
        stage('Clean'){
            steps{
                script {
                    try{
                        sh "docker stop ${BACK_SPRING_CONTAINER_NAME}"
                        sh "docker stop ${BACK_FLASK_CONTAINER_NAME}"
                        sleep 1
                        sh "docker rm ${BACK_SPRING_CONTAINER_NAME}"
                        sh "docker rm ${BACK_FLASK_CONTAINER_NAME}"
                    }catch(e){
                        sh 'exit 0'
                    }
                }
            }
        }
        stage('Build') {
            steps {
                script{
                     sh "docker build -t ${BACK_SPRING_NAME} ./BE/candy/."
                     sh "docker build -t ${BACK_FLASK_NAME} ./BE/flaskServer/."
                }
            }
        }
        stage('Deploy'){
            steps {  sh "docker run -d --name=${BACK_SPRING_CONTAINER_NAME} -p 8080:8080 -e JAVA_OPTS=-Djasypt.encryptor.password=candy@b105 ${BACK_SPRING_NAME}"
                sh "docker run -d --name=${BACK_FLASK_CONTAINER_NAME} -p 0.0.0.0:90:5000 ${BACK_FLASK_NAME}"
                sh "docker image prune --force"
            }
        }
    }
}

```


### 7. Dockerfile ÏÉùÏÑ±

- Back Spring Boot ÏÑúÎ≤Ñ

```bash
FROM openjdk:11 AS builder
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src
RUN chmod =x ./gradlew
RUN ./gradlew bootJar

FROM openjdk:11
COPY --from=builder build/libs/candy-0.0.1-SNAPSHOT.jar candy.jar

EXPOSE 8080

ENTRYPOINT ["sh", "-c", "java ${JAVA_OPTS} -jar candy.jar"]
```

- Back flask ÏÑúÎ≤Ñ

```bash
# base image
FROM python:3.9.10

# set working directory
# WORKDIR /app

# copy requirements file
COPY requirements.txt .

# install requirements
RUN pip install --no-cache-dir -r requirements.txt

# copy application files
COPY . .

# expose port
EXPOSE 90

# start application
CMD ["flask", "run", "--host=0.0.0.0"]
```

### 8. Redis ÏÑ§Ïπò

- apt-get update

```
sudo apt-get update
sudo apt-get upgrade
```

- redis ÏÑ§Ïπò Î∞è Î≤ÑÏ†Ñ ÌôïÏù∏

```
sudo apt-get install redis-server
redis-server --version
```

- configÏÑ§Ï†ï

```
sudo nano /etc/redis/redis.conf //confÎì§Ïñ¥Í∞ÄÏÑú

# bind 127.0.0.1
bind 0.0.0.0: // Î∞îÏù∏Îìú ÏÑ§Ï†ï Î≥ÄÍ≤Ω (ctrl+wÎ°ú serach)

# requirepass Ï£ºÏÑùÌíÄÏñ¥ÏÑú
requirepass ÎπÑÎ∞ÄÎ≤àÌò∏
```

- redis Ïû¨ ÏãúÏûë

```
sudo service redis-server restart
```

### 9. ngrinder ÏÑ§Ïπò 

- controller image pull
```
docker pull ngrinder/controller
```

- controller ÏÑ§Ïπò
```
docker run -d -v ~/ngrinder-controller:/opt/ngrinder-controller --name controller -p 8100:80 -p 16001:16001 -p 12000-12009:12000-12009 ngrinder/controller
```

- agent image pull
```
docker pull ngrinder/agent
```

- agent ÏÑ§Ïπò 
```
docker run -d -v ~/ngrinder-agent:/opt/ngrinder-agent --name agent ngrinder/agent controller
```

---

## Î∞±ÏóîÎìú ymlÌååÏùº
```
server:
  port: 8080
  error:
    whitelabel:
      enabled: false
  servlet:
    context-path: /api

spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
#    url: jdbc:mysql://${DB_DOMAIN}:${DB_PORT}/candy?serverTimezone=Asia/Seoul&characterEncoding=UTF-8
#    username: ${DB_USERNAME}
#    password: ${DB_PASSWORD}
    url: ENC(I3WC6f7XbissxnqTpHqW/U84u9kB/8Gofpedx34pZhbYUegQSUhzFwVfV3UvtFntZ+5tcWBhzQGfR/iTAb9Trg+OqunykgGyFZtAmlpVQ915PtK8RznH56xyhdKInCj5zpotQiYOzkA=)
    username: ENC(I8pMeRhANPbTigt8FCD40g==)
    password: ENC(6q5oI1uTTpEEl/8Xx7O6rOyHX1sZmp77)

  jpa:
    open-in-view: false
    show-sql: true
    hibernate:
      ddl-auto: none
#      ddl-auto: create
    properties:
      hibernate:
        # sql Î≥ÄÏàò ÏÉùÏÑ± Ïãú ÏûêÎèôÏúºÎ°ú ``ÏúºÎ°ú Í∞êÏã∏Ï§ÄÎã§.
        globally_quoted_identifiers: true
        # ÏΩòÏÜîÏóê Îú®Îäî sql Î≥¥Í∏∞ Ï¢ãÍ≤å ÎßåÎì§Ïñ¥Ï§ÄÎã§.
        format_sql: true

  redis:
    host: ENC(jr0SM42I4qYjhfJ8gelc8SNCmKXv7n5u60vxpRf8nRc=)
    port: 6379
    password: ENC(KNbWApPqG31bZT7D95uv0iLjKwbN86Ly)
  cache: redis

logging:
  level:
    org:
      hibernate:
        SQL: DEBUG
        type:
          descriptor:
            sql:
              BasicBinder: TRACE


management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    prometheus:
      enabled: true
  metrics:
    tags:
      application: candy
  export:
    prometheus:
      enabled: true
```

---

## üíæ Ìè¨ÌåÖ Îß§Îâ¥Ïñº

| Ìè¨Ìä∏        | Ïú†Ìòï    | ÌîÑÎ°úÍ∑∏Îû®         | ÏÇ¨Ïö©Ìè¨Ìä∏ÎÇ¥Ïö©                                      |
| ----------- | ------- | ---------------- | ------------------------------------------------- |
| 22          | TCP     | SSH              | Ubuntu Ï†ëÏÜçÏùÑ ÏúÑÌï¥                                |
| 80          | TCP     | HTTP             | HTTP Í∏∞Î≥∏ Port                                    |
| 90          | TCP     | DOCKER, FLASK    | candy_back_flask_controllerÏùò Flask Server Port   |
| 443         | TCP     | HTTPS            | HTTPS Í∏∞Î≥∏ Port                                   |
| 8080        | TCP     | DOCKER, Spring   | candy_back_spring_controllerÏùò Spring Server Port |
| 8100        | TCP     | DOCKER, ngrinder | Î∂ÄÌïòÌÖåÏä§Ìä∏Î•º ÏúÑÌïú port (80 -> 8100)                |
| 9090        | TCP     | DOCKER, Jenkins  | Jenkins Port(8080 ‚Üí 9090)                         |
| 9091        | TCP     | DOCKER, Jenkins  | SSL Ïù∏Ï¶ù Jenkins(9090 ‚Üí 9091)                     |

